<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Example</title>
</head>
<body>

    <script>
        function load() {
            fetchConfig().then(function(matches) {
                var main = document.getElementsByTagName("body")[0];
                var matchIds = []
                for(match of matches) {
                    matchIds.push(match.id)
                }
                fetchOdds(matchIds).then(function(odds) {
                    for(match of matches) {
                        var game = createTag("div", match.naziv);
                        var league = createTag("div", match.liga);
                        var time = createTag("div", match.vrijeme);
                        var oddsTag = parseOdds(odds[match.id]);
                        main.appendChild(game);
                        main.appendChild(league);
                        main.appendChild(time);
                        main.appendChild(oddsTag);
                        main.append(document.createElement("br"));
                    }
                });
            });
        }

        function parseOdds(list) {
            var div = document.createElement("div");
            for(item of list) {
                var name = createTag("span", item.naziv);
                var odd = createTag("span", item.tecaj);
                var span = document.createElement("span");
                span.appendChild(name);
                span.appendChild(document.createTextNode(" - "));
                span.appendChild(odd);
                div.appendChild(span);
                div.appendChild(document.createTextNode(" | "));
            }
            return div;
        }

        function fetchOdds(ids) {
            var oddsUrl = "http://localhost:8000/games/details";
            return makeRequest("POST", oddsUrl, {matchIds: ids}).then(function(response) {
                response = JSON.parse(response);
                var offers = {};
                for(item of response) {
                    offers[item.baseId] = item.ponude[0].tecajevi;
                }
                return offers;
            });
        }

        function createTag(element, content) {
            var el = document.createElement(element);
            el.innerHTML = content;
            return el;
        }

        function fetchConfig() {
            // var configUrl = "https://www.supersport.hr/s3/assets/promo_banners.json";
            var configUrl = "http://localhost:8000/promo_banners";
            return makeRequest("GET", configUrl, null).then(function(config) {
                config = JSON.parse(config);
                return config.promo.utakmice;
            });
        }

        function makeRequest(httpVerb, url, body) {
            return new Promise(function(resolve, reject) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open(httpVerb, url, true);
                xmlHttp.onload = function(e) {
                    if(xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                        resolve(xmlHttp.responseText);
                    }
                }
                xmlHttp.onerror = function(e) {
                    reject({
                        status: this.status,
                        statusText: xhr.statusText
                    });
                }
                xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xmlHttp.send(JSON.stringify(body));
            });
            
        }

        function clearBody() {
            var body = document.getElementsByTagName("body")[0];
            body.textContent = "";
        }

        function start() {
            load();
            var frequency = 30 * 1000;
            setInterval(function() {
                clearBody();
                load();
            }, frequency);
        }

        start();
    </script>
</body>
</html>